# =============================================================================
# Release Please Workflow
# Automates versioning and changelog generation based on Conventional Commits
# =============================================================================
#
# This workflow:
# 1. Creates/updates a release PR when commits are pushed to main
# 2. Updates CHANGELOG.md based on conventional commit messages
# 3. Bumps version in Cargo.toml files
# 4. Creates a GitHub release when the PR is merged
#
# Commit message format:
#   feat: add new feature       -> Minor version bump
#   fix: fix a bug              -> Patch version bump
#   feat!: breaking change      -> Major version bump (after 1.0)
#   chore: maintenance          -> No version bump
#
# =============================================================================

name: Release Please

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: write

# Cancel in-progress runs for the same workflow/ref
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      sha: ${{ steps.release.outputs.sha }}
    steps:
      - name: Run Release Please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          # Use the configuration files in the repository
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
          # Token with write permissions
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Output Release Info
        if: ${{ steps.release.outputs.release_created }}
        run: |
          echo "Release created: ${{ steps.release.outputs.release_created }}"
          echo "Tag: ${{ steps.release.outputs.tag_name }}"
          echo "Version: ${{ steps.release.outputs.version }}"
          echo "SHA: ${{ steps.release.outputs.sha }}"

  # Trigger downstream workflows on release
  trigger-workflows:
    name: Trigger Release Workflows
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Docker Build
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'docker.yml',
              ref: 'main',
              inputs: {
                version: '${{ needs.release-please.outputs.version }}',
                tag: '${{ needs.release-please.outputs.tag_name }}'
              }
            })

      - name: Trigger Documentation Build
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'docs.yml',
              ref: 'main',
              inputs: {
                version: '${{ needs.release-please.outputs.version }}'
              }
            })

  # Build and upload release binaries
  build-binaries:
    name: Build Release Binaries
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            name: linux-x86_64
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            name: linux-arm64
          - target: x86_64-apple-darwin
            os: macos-latest
            name: macos-x86_64
          - target: aarch64-apple-darwin
            os: macos-latest
            name: macos-arm64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.release-please.outputs.tag_name }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.93.0"
          targets: ${{ matrix.target }}

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      - name: Install OpenSSL (Linux x86_64)
        if: matrix.target == 'x86_64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config

      - name: Install cross-compilation tools (Linux ARM64)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          # Install OpenSSL for cross-compilation
          sudo dpkg --add-architecture arm64
          sudo sed -i 's/^deb /deb [arch=amd64] /' /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports $(lsb_release -cs) main restricted universe multiverse" | sudo tee /etc/apt/sources.list.d/arm64.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports $(lsb_release -cs)-updates main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list.d/arm64.list
          sudo apt-get update
          sudo apt-get install -y libssl-dev:arm64

      - name: Configure cross-compilation (Linux ARM64)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          echo "[target.aarch64-unknown-linux-gnu]" >> ~/.cargo/config.toml
          echo "linker = \"aarch64-linux-gnu-gcc\"" >> ~/.cargo/config.toml
        env:
          PKG_CONFIG_ALLOW_CROSS: 1
          PKG_CONFIG_PATH: /usr/lib/aarch64-linux-gnu/pkgconfig
          OPENSSL_DIR: /usr
          OPENSSL_LIB_DIR: /usr/lib/aarch64-linux-gnu
          OPENSSL_INCLUDE_DIR: /usr/include

      - name: Build release binaries (native)
        if: matrix.target != 'aarch64-unknown-linux-gnu'
        run: |
          cargo build --release --target ${{ matrix.target }} \
            -p presentation_cli \
            -p presentation_http

      - name: Build release binaries (ARM64 cross-compile)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          cargo build --release --target ${{ matrix.target }} \
            -p presentation_cli \
            -p presentation_http
        env:
          PKG_CONFIG_ALLOW_CROSS: "1"
          PKG_CONFIG_PATH: /usr/lib/aarch64-linux-gnu/pkgconfig
          OPENSSL_DIR: /usr
          OPENSSL_LIB_DIR: /usr/lib/aarch64-linux-gnu
          OPENSSL_INCLUDE_DIR: /usr/include

      - name: Package binaries
        run: |
          VERSION="${{ needs.release-please.outputs.version }}"
          mkdir -p dist
          
          # Package CLI
          cp target/${{ matrix.target }}/release/pisovereign-cli \
             dist/pisovereign-cli-${VERSION}-${{ matrix.name }}
          
          # Package Server
          cp target/${{ matrix.target }}/release/pisovereign-server \
             dist/pisovereign-server-${VERSION}-${{ matrix.name }}
          
          # Create checksums
          cd dist
          sha256sum * > checksums-${{ matrix.name }}.txt

      - name: Upload binaries to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          files: |
            dist/pisovereign-cli-*
            dist/pisovereign-server-*
            dist/checksums-*.txt
