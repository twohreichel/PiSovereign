# =============================================================================
# Tarpaulin Coverage Configuration
# =============================================================================
#
# Generate coverage: cargo tarpaulin
# Open HTML report: just coverage-open
# CI uses LCOV for Codecov upload
#
# Documentation: https://github.com/xd009642/tarpaulin

[tarpaulin]
# Run with all features enabled for complete coverage
all-features = true

# Test all workspace crates
workspace = true

# Timeout for long-running integration tests
timeout = "300s"

# Engine selection:
# - Ptrace: Default on Linux, not available on macOS
# - Llvm: Cross-platform, required for aarch64/macOS
engine = "Llvm"

# Fail the build if coverage drops below 90%
# Comprehensive unit and integration tests ensure high coverage
fail-under = 80

# Enable branch coverage for comprehensive testing
branch = true

# Limit test threads for stable async test execution
test-threads = 4

# Include ignored tests for optional integration tests
run-ignored = true

# Output formats:
# - Html: Local development reports
# - Lcov: CI/Codecov integration
out = ["Html", "Lcov"]

# Output directory for reports
output-dir = "target/coverage"

# Skip cleaning before build (faster for CI caching)
skip-clean = true

# Exclude files that don't contain testable business logic
# These are infrastructure/integration pieces tested via testcontainers or require external services
exclude-files = [
    # Binary entry points
    "*/main.rs",
    # Benchmark code
    "*/benches/*",
    # Adapters requiring external services
    "*/adapters/*",
    # Persistence code requiring database
    "*/persistence/*",
    # Testing infrastructure
    "*/testing/*",
    # Telemetry setup
    "*/telemetry/*",
    # HTTP handlers (integration tested)
    "*/handlers/*",
    # Config reload, state management
    "*/config_reload.rs",
    "*/state.rs",
    "*/middleware/request_id.rs",
    # CalDAV task import (complex iCalendar parsing)
    "*/integration_caldav/src/task.rs",
    # IMAP/SMTP clients (tested with testcontainers)
    "*/imap_client.rs",
    "*/smtp_client.rs",
]

# Exclude entire crates
exclude = [
    # CLI is bin-only without lib.rs - minimal coverage value
    "presentation_cli",
]

# Verbose output for debugging coverage issues
# Uncomment for troubleshooting:
# verbose = true

# Follow test execution with line-by-line output
# Uncomment for troubleshooting:
# follow-exec = true

# =============================================================================
# CI Profile - Stricter settings for continuous integration
# =============================================================================
[ci]
all-features = true
workspace = true
timeout = "600s"
engine = "Llvm"
fail-under = 90
branch = true
test-threads = 2
out = ["Lcov"]
output-dir = "target/coverage"
skip-clean = true
exclude-files = [
    "*/main.rs",
    "*/benches/*",
    "*/adapters/*",
    "*/persistence/*",
    "*/testing/*",
    "*/telemetry/*",
    "*/handlers/*",
    "*/config_reload.rs",
    "*/state.rs",
    "*/middleware/request_id.rs",
    "*/integration_caldav/src/task.rs",
    "*/imap_client.rs",
    "*/smtp_client.rs",
]
exclude = ["presentation_cli"]

# =============================================================================
# Local Profile - Faster feedback for development
# =============================================================================
[local]
all-features = true
workspace = true
timeout = "300s"
engine = "Llvm"
fail-under = 85
branch = false
test-threads = 8
out = ["Html"]
output-dir = "target/coverage"
skip-clean = true
exclude-files = [
    "*/main.rs",
    "*/benches/*",
    "*/adapters/*",
    "*/persistence/*",
    "*/testing/*",
    "*/telemetry/*",
    "*/handlers/*",
    "*/config_reload.rs",
    "*/state.rs",
    "*/middleware/request_id.rs",
    "*/integration_caldav/src/task.rs",
    "*/imap_client.rs",
    "*/smtp_client.rs",
]
exclude = ["presentation_cli"]
