# =============================================================================
# PiSovereign Production Override
# Use with: docker compose -f docker-compose.yml -f docker-compose.production.yml up -d
# =============================================================================
#
# Required Environment Variables:
#   TRAEFIK_ACME_EMAIL    - Email for Let's Encrypt certificate notifications
#   PISOVEREIGN_DOMAIN    - Your domain (e.g., pisovereign.example.com)
#
# Optional Environment Variables:
#   GRAFANA_ADMIN_PASSWORD - Grafana admin password (default: pisovereign)
#
# Example:
#   export TRAEFIK_ACME_EMAIL=admin@example.com
#   export PISOVEREIGN_DOMAIN=pisovereign.example.com
#   docker compose -f docker-compose.yml -f docker-compose.production.yml up -d
#
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Traefik - Enable production profile and override settings
  # ---------------------------------------------------------------------------
  traefik:
    profiles: []  # Remove profile restriction, always start in production
    command:
      # API and Dashboard (disabled in production)
      - "--api.dashboard=false"
      - "--api.insecure=false"
      - "--ping=true"
      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # HTTP to HTTPS redirect
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
      # Let's Encrypt ACME
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.email=${TRAEFIK_ACME_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      # Docker provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=pisovereign-network"
      # Logging
      - "--log.level=WARN"
      - "--accesslog=true"
      - "--accesslog.format=json"
      - "--accesslog.filepath=/var/log/traefik/access.log"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-letsencrypt:/letsencrypt
      - traefik-logs:/var/log/traefik

  # ---------------------------------------------------------------------------
  # PiSovereign Application (Production Config)
  # ---------------------------------------------------------------------------
  pisovereign:
    # Remove direct port exposure in production (routed via Traefik)
    ports:
      - "8080:8080"   # Prometheus metrics (internal only)
    environment:
      - RUST_LOG=info
      - PISOVEREIGN_CONFIG=/app/config/config.toml
      - PISOVEREIGN_DATA_DIR=/app/data
      - PISOVEREIGN_ENVIRONMENT=production
    labels:
      - "traefik.enable=true"
      # HTTP Router
      - "traefik.http.routers.pisovereign.rule=Host(`${PISOVEREIGN_DOMAIN}`)"
      - "traefik.http.routers.pisovereign.entrypoints=websecure"
      - "traefik.http.routers.pisovereign.tls.certresolver=letsencrypt"
      # Service
      - "traefik.http.services.pisovereign.loadbalancer.server.port=3000"
      # Security headers middleware
      - "traefik.http.middlewares.pisovereign-security.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.pisovereign-security.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.pisovereign-security.headers.stsPreload=true"
      - "traefik.http.middlewares.pisovereign-security.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.pisovereign-security.headers.frameDeny=true"
      - "traefik.http.middlewares.pisovereign-security.headers.browserXssFilter=true"
      - "traefik.http.middlewares.pisovereign-security.headers.referrerPolicy=strict-origin-when-cross-origin"
      - "traefik.http.middlewares.pisovereign-security.headers.customResponseHeaders.X-Robots-Tag=noindex,nofollow"
      # Rate limiting middleware
      - "traefik.http.middlewares.pisovereign-ratelimit.ratelimit.average=100"
      - "traefik.http.middlewares.pisovereign-ratelimit.ratelimit.burst=50"
      - "traefik.http.middlewares.pisovereign-ratelimit.ratelimit.period=1m"
      # Apply middlewares
      - "traefik.http.routers.pisovereign.middlewares=pisovereign-security,pisovereign-ratelimit"

  # ---------------------------------------------------------------------------
  # Grafana - Production Config
  # ---------------------------------------------------------------------------
  grafana:
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-pisovereign}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=https://${PISOVEREIGN_DOMAIN}/grafana
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`${PISOVEREIGN_DOMAIN}`) && PathPrefix(`/grafana`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls.certresolver=letsencrypt"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"
      - "traefik.http.middlewares.grafana-stripprefix.stripprefix.prefixes=/grafana"
      - "traefik.http.routers.grafana.middlewares=grafana-stripprefix"

# =============================================================================
# Additional Volumes for Production
# =============================================================================
volumes:
  traefik-logs:
    driver: local
